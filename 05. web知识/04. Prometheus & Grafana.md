# 学习结构

- Prometheus 数据采集
- Grafana 数据展现
- 云 报警

# Prometheus

## 特点

- 易于管理
  - 核心只有一个二进制文件，在本地磁盘
- pull模式
  - 非push模式，可以在任何地方（本地、开发、测试）搭建监控系统
- 服务发现（Service Discovery）
  - 服务器server增加的时候自动发现
  - 单个Prometheus Server不够用了，可以导入 功能分区（sharding）+联邦集群（federation）
- TSDB数据模型
- 查询语言PromQL
- 高效

- 支持多编程语言：Java、Python、Go、Ruby……
- GO语言编写的，Google

## 架构

- 维度存储模型
  - 以时间维度、存储时间序列
  - OLAP系统， Online Analytical Processing， 联机分析处理【处理大规模数据的系统
- 在各层的操作
  - 采集层
    - Pushgateway
      - 生命周期较短的作业
      - 退出时间指标推送
      - 推送到统一gateway
    - Node Exporter / Job
      - 生命周期较长的作业
      - 基本一致在一个server运行的
  - 存储计算层
    - Prometheus Server ，包含存储引擎、计算引擎
    - Retrievcval取数组件，从采集层获取
    - Service discovery，动态发现监控目标
    - TSDB，数据核心存储和查询
    - HTTP server，对外提供http服务
  - 应用层
    - AlertManager
      - 告警组件
    - 数据可视化
      - webUI / 对接Grafana / 其他API

## 安装 & 配置

### 应该下载什么

- 根据需要下载
- 需要报警——alertmanager
- 核心服务——prometheus
- 需要段时间服务——pushgateway

### 下载

```shell
tar -zxvf xxxxx.tar.gz -C xxxxx
mv xxxxx xxxxx #重命名
```

### 配置文件

- promethus.yml
- 能够配置的信息
  - 间隔时间
  - tagets：从哪里获得数据
  - pushgateway / node exporter【配置数据获取方式

### 采集节点管理

- 手动分发节点

  - 输入命令，加入监控节点

    `xsync node_exporter-1.2.2`

- 自动分发节点
  - 设置自启动 Linux

### 设置Prometheus的自动启动

- 后台执行Prometheus和相关服务（exporter /  pushgateway / 报警服务器）

## PromQL

### 特征 

- Prometheus通过指标名称（metrics name）和标签（labelset）唯一定义一条时间序列/
- PromQL就是用于对 TSDB 的操作、查询 的语言
- 支持正则表达式
- 范围查询
  - 正常只包含当前时间点的，“瞬时向量”
  - 可以查看五分钟内的，“区间向量” [5s]
  - 也可以进行时间位移 offset 5m
- 聚合操作
  - sum()
- 标量和字符串
  - 可以使用num/str
- 指定监控指标
  - \__name\__
- 操作符
  - 数字 / 布尔 / 优先级
  - 聚合函数 sum/ avg ...

## 和其他 server 的集成

- 在项目中导入prometheus的jar包
- 在项目中进行配置
  - 通过Prometheus的 pushgateway / exporters
  - 标签的前缀后缀
  - 多久拉取一次

#### Spring  Boot 和 Prometheus的集成

- pom.xml中导入依赖
- 在.yml配置文件中开启服务

# Grafana

## 特点

- go语言编写
- 用于大规模指标数据的可视化展现
- 支持TSDB

## 安装

- 下载安装
- 后台运行grafana-server

## 配置

- 配置数据来源
  - Setting / Datasource，比如配置成Prometheus
    - 指定HTTP的URL
    - save / test
- 创建仪表盘 Dashboard
  - +号 / Dashboard
    - panel：一个指标的战士面板
    - row：包含多个panel
  - 选择指标 / 设置排版
  - 也可以使用社区分享的模版
    - 如何分辨
      - 下载数
      - reviews
    - 如何使用
      - 官网 / Dashboard / 关键字（Node Exporters / Spring ...）
      - 在社区上 Download JSON 
      - +号 / Import / Upload JSON / 命名 / 选择数据源

## Grafana 监控 server

- 依赖关系
  - 进程本身需要 pushgateway / node exporter 监控
  - Prometheus监视采集
  - Grafana监视Prometheus
- 写脚本控制

# 云告警

## 步骤

- 打开智能告警平台
- 在Grafana里面通过webhook，将 云 和 Grafana 连接起来
- 在 云告警服务器 中创建 分派策略

# 监控实例

- 根据 任务 找到 可以使用的指标
- 如果达到指标、根据指标达到了某种条件，创建告警

## 常见场景

- 监视网路延迟
